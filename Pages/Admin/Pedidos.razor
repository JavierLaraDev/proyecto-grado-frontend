@page "/pedidos"
@attribute [Authorize(Roles = "0")]

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using PersonalizacionProyectoGradoWASM.Modelos
@using PersonalizacionProyectoGradoWASM.Servicios.IServicios
@using System.Security.Claims

@inject IPedidosServicio PedidosServicio
@inject IUsuariosServicio UsuariosServicio
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ILogger<Pedidos> Logger

<section class="users-page">

    <!-- HEADER -->
    <div class="users-header">
        <h1>Gestión de Pedidos</h1>
    </div>

    <!-- FILTROS -->
    <div class="users-filters">
        <input class="users-input"
               placeholder="Buscar por nombre del cliente"
               @bind="filtroNombre"
               @bind:event="oninput" />

        <select class="users-select"
                @bind="filtroEstado">
            <option value="">Todos los estados</option>
            @foreach (var estado in Enum.GetValues(typeof(EstadoPedido)))
            {
                <option value="@estado">@estado</option>
            }
        </select>
    </div>

    @if (cargando)
    {
        <div class="users-state">Cargando pedidos...</div>
    }
    else if (!string.IsNullOrEmpty(error))
    {
        <div class="users-error">@error</div>
    }
    else
    {
        <div class="users-table-wrapper">
            <table class="users-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Cliente</th>
                        <th>Celular</th>
                        <th>Fecha</th>
                        <th>Total</th>
                        <th>Estado</th>
                        <th class="col-actions">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @if (pedidosFiltrados.Any())
                    {
                        @foreach (var pedido in pedidosFiltrados)
                        {
                            var usuario = usuarios.FirstOrDefault(u => u.Id == pedido.UsuarioId);

                            <tr>
                                <td>@pedido.Id</td>
                                <td>@(usuario != null ? $"{usuario.Nombre} {usuario.Apellido}" : "N/A")</td>
                                <td>@(usuario != null ? FormatearCelular(usuario.NumeroCelular) : "N/A")</td>
                                <td>@pedido.FechaCreacion.ToString("dd/MM/yyyy HH:mm")</td>
                                <td>Bs @pedido.PrecioTotal.ToString("F2")</td>
                                <td>
                                    <span class="pedido-estado @pedido.Estado.ToString().ToLower()">
                                        @pedido.Estado
                                    </span>
                                </td>
                                <td class="col-actions">
                                    <button class="users-btn-edit"
                                            @onclick="() => AbrirDetalle(pedido.Id)">
                                        Detalles
                                    </button>

                                    <button class="users-btn-primary"
                                            @onclick="() => AbrirEstado(pedido)">
                                        Estado
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="7" class="users-state">
                                No hay pedidos para mostrar.
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</section>

<!-- MODAL DETALLE -->
<PedidoDetalleModal Pedido="pedidoDetalle"
                    OnCerrar="CerrarDetalle" />

<!-- MODAL ESTADO -->
<PedidoEstadoModal Pedido="pedidoEstado"
                   OnConfirmar="GuardarEstado"
                   OnCancelar="CerrarEstado" />

@code {

    // =========================
    // ESTADO
    // =========================
    private List<PedidosComprasDto> pedidos = new();
    private List<PedidosComprasDto> pedidosFiltrados = new();
    private IEnumerable<UsuarioGestion> usuarios = Enumerable.Empty<UsuarioGestion>();

    private PedidosComprasDto pedidoDetalle;
    private PedidosComprasDto pedidoEstado;

    private bool cargando = true;
    private string error;

    private string filtroNombre = "";
    private string filtroEstado = "";

    // =========================
    // CICLO DE VIDA
    // =========================
    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            if (!authState.User.IsInRole("0"))
            {
                error = "No tiene permisos para acceder a esta página.";
                return;
            }

            await CargarDatos();
        }
        catch (Exception ex)
        {
            error = "Error al cargar la página.";
            Logger.LogError(ex, error);
        }
        finally
        {
            cargando = false;
        }
    }

    // =========================
    // DATOS
    // =========================
    private async Task CargarDatos()
    {
        var pedidosTask = PedidosServicio.GetPedidos();
        var usuariosTask = UsuariosServicio.GetUsuarios();

        await Task.WhenAll(pedidosTask, usuariosTask);

        pedidos = await pedidosTask;
        usuarios = await usuariosTask;

        Filtrar();
    }

    private void Filtrar()
    {
        pedidosFiltrados = pedidos.Where(p =>
            (string.IsNullOrEmpty(filtroNombre) ||
             $"{usuarios.FirstOrDefault(u => u.Id == p.UsuarioId)?.Nombre} {usuarios.FirstOrDefault(u => u.Id == p.UsuarioId)?.Apellido}"
             .Contains(filtroNombre, StringComparison.OrdinalIgnoreCase))
            &&
            (string.IsNullOrEmpty(filtroEstado) || p.Estado.ToString() == filtroEstado)
        ).ToList();
    }

    // =========================
    // MODAL DETALLE
    // =========================
    private async Task AbrirDetalle(int pedidoId)
    {
        pedidoDetalle = await PedidosServicio.GetPedido(pedidoId);
    }

    private void CerrarDetalle()
    {
        pedidoDetalle = null;
    }

    // =========================
    // MODAL ESTADO
    // =========================
    private void AbrirEstado(PedidosComprasDto pedido)
    {
        pedidoEstado = pedido;
    }

    private void CerrarEstado()
    {
        pedidoEstado = null;
    }

    private async Task GuardarEstado(EstadoPedido nuevoEstado)
    {
        if (pedidoEstado == null) return;

        await PedidosServicio.ActualizarEstadoPedido(pedidoEstado.Id, nuevoEstado);
        pedidoEstado = null;

        await CargarDatos();
    }

    // =========================
    // UTIL
    // =========================
    private string FormatearCelular(int numero)
        => numero.ToString("### ### ###");

    protected override void OnParametersSet()
    {
        Filtrar();
    }
}
