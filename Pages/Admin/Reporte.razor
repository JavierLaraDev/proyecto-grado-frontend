@page "/reportes"
@attribute [Authorize(Roles = "0")]
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using OfficeOpenXml
@using PersonalizacionProyectoGradoWASM.Components.Reportes
@using PersonalizacionProyectoGradoWASM.Servicios
@using PersonalizacionProyectoGradoWASM.Modelos
@using PersonalizacionProyectoGradoWASM.Servicios.IServicios
@using System.Security.Claims
@using iTextSharp.text
@using iTextSharp.text.pdf
@inject IPedidosServicio CarritoComprasServicio
@inject IUsuariosServicio UsuariosServicio
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JSRuntime

<section class="dashboard">

    <header class="dashboard-header">
        <h1>Dashboard de Reportes</h1>
        <p>Análisis completo del negocio</p>
    </header>

    <ReportesFiltros 
        Periodo="@periodo"
        PeriodoChanged="@(p => periodo = p)"
        Mes="@mes"
        MesChanged="@(m => mes = m)"
        Anio="@anio"
        AnioChanged="@(a => anio = a)" />

    <ReportesKPIs 
        TotalPedidos="@totalPedidos"
        TotalUsuarios="@totalUsuarios"
        Ganancias="@gananciasTotales" />

    <ReportesGraficos 
        PedidosPendientes="@pedidosPendientes"
        PedidosProceso="@pedidosEnProceso"
        PedidosEnviados="@pedidosEnviados"
        PedidosEntregados="@pedidosEntregados"
        PedidosCancelados="@pedidosCancelados" />

    <ReportesTabla 
        Pedidos="@pedidos"
        OnVerDetalle="VerDetallesPedido" />

</section>

@if (pedidoSeleccionado != null)
{
    <div class="modal show d-block">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>Pedido #@pedidoSeleccionado.Id</h5>
                    <button class="btn-close" @onclick="CerrarModal"></button>
                </div>
                <div class="modal-body">
                    <p><b>Usuario:</b> @pedidoSeleccionado.UsuarioId</p>
                    <p><b>Fecha:</b> @pedidoSeleccionado.FechaCreacion</p>
                    <p><b>Estado:</b> @pedidoSeleccionado.Estado</p>
                    <hr />
                    <ul>
                        @foreach (var item in pedidoSeleccionado.Items)
                        {
                            <li>@item.Accesorio.Nombre - Bs @item.Accesorio.Precio</li>
                        }
                    </ul>
                    <hr />
                    <b>Total: Bs @pedidoSeleccionado.PrecioTotal</b>
                </div>
            </div>
        </div>
    </div>
}

@code {

    private List<PedidosComprasDto> pedidos = new();
    private PedidosComprasDto pedidoSeleccionado;

    private string periodo = "mensual";
    private int mes = DateTime.Today.Month;
    private int anio = DateTime.Today.Year;

    private int totalPedidos;
    private int totalUsuarios;
    private double gananciasTotales;

    private int pedidosPendientes;
    private int pedidosEnProceso;
    private int pedidosEnviados;
    private int pedidosEntregados;
    private int pedidosCancelados;

    protected override async Task OnInitializedAsync()
    {
        pedidos = await CarritoComprasServicio.GetPedidos();
        totalPedidos = pedidos.Count;
        gananciasTotales = pedidos.Where(p => p.Estado == EstadoPedido.Entregado)
                                  .Sum(p => p.PrecioTotal);

        pedidosPendientes = pedidos.Count(p => p.Estado == EstadoPedido.Pendiente);
        pedidosEnProceso = pedidos.Count(p => p.Estado == EstadoPedido.EnProceso);
        pedidosEnviados = pedidos.Count(p => p.Estado == EstadoPedido.Enviado);
        pedidosEntregados = pedidos.Count(p => p.Estado == EstadoPedido.Entregado);
        pedidosCancelados = pedidos.Count(p => p.Estado == EstadoPedido.Cancelado);

        totalUsuarios = (await UsuariosServicio.GetUsuarios()).Count();
    }

    void VerDetallesPedido(int id)
    {
        pedidoSeleccionado = pedidos.First(x => x.Id == id);
    }

    void CerrarModal() => pedidoSeleccionado = null;
}