@page "/bicicleta-personalizada"
@using Microsoft.AspNetCore.Components.Authorization
@using Newtonsoft.Json
@using PersonalizacionProyectoGradoWASM.Servicios.IServicios
@using PersonalizacionProyectoGradoWASM.Modelos
@using Microsoft.AspNetCore.Authorization
@using System.Security.Claims

@inject IJSRuntime JSRuntime
@inject IAccesoriosServicio AccesoriosServicio
@inject IPedidosServicio CarritoComprasServicio
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager

@attribute [Authorize(Roles = "1")]

<PageTitle>Personaliza tu Bicicleta</PageTitle>

<section id="personalizar">
    <div class="grid-layout">

        <!-- COLUMNA IZQUIERDA -->
        <div class="left-panel card">
            <h2 class="title">Accesorios</h2>

            @foreach (var tipoAccesorio in tiposAccesorios)
            {
                <div class="form-group">
                    <label>@tipoAccesorio:</label>
                    <select class="select-input"
                            @onchange="@(e => CambiarAccesorio(tipoAccesorio, e.Value?.ToString()))">
                        <option value="">Seleccione @tipoAccesorio</option>

                        @if (accesoriosPorTipo.ContainsKey(tipoAccesorio))
                        {
                            @foreach (var accesorio in accesoriosPorTipo[tipoAccesorio])
                            {
                                <option value="@accesorio.Id">
                                    @accesorio.Descripcion - Bs @accesorio.Precio.ToString("F2")
                                </option>
                            }
                        }
                    </select>
                </div>
            }
        </div>

        <!-- CANVAS 3D -->
        <div class="center-panel">
            <div class="canvas-wrapper">
                <canvas id="renderCanvas"></canvas>
            </div>
        </div>

        <!-- COLUMNA DERECHA -->
        <div class="right-panel">

            <div class="card small-card">
                <p class="price-label">Color:</p>
                <input type="color"
                       class="input-color"
                       @bind="colorBicicleta"
                       @bind:event="oninput"
                       @onchange="CambiarColorBicicleta" />
            </div>

            <div class="card small-card">
                <p class="price-label">Precio Total</p>
                <p class="price-value">Bs @precioTotal.ToString("F2")</p>
            </div>

            <button class="btn-main" @onclick="RealizarPedido">
                Realizar Pedido
            </button>

        </div>
    </div>
</section>

@code {

    private string rutaModelo3D;
    private List<string> tiposAccesorios = new()
    {
        "Montura", "Bocina", "Canasta", "Espejos", "Mangos", "Timbre", "Asiento para Niño "
    };

    private Dictionary<string, List<Accesorio>> accesoriosPorTipo = new();
    private Dictionary<string, Accesorio> accesoriosSeleccionados = new();

    private double precioTotal = 0;
    private Accesorio bicicletaBase;
    private int userId;
    private string colorBicicleta = "#000000";

    private bool usuarioInicializado = false;

    // 🔴 CAMBIO CLAVE AQUÍ
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !usuarioInicializado)
        {
            await ObtenerUsuarioId();
            await CargarAccesorios();
            await CargarModeloBicicleta();

            usuarioInicializado = true;
            StateHasChanged();
        }
    }

    private async Task ObtenerUsuarioId()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (!user.Identity.IsAuthenticated)
            throw new Exception("Usuario no autenticado");

        var claim = user.FindFirst(ClaimTypes.NameIdentifier);

        if (claim == null || !int.TryParse(claim.Value, out userId))
            throw new Exception("No se pudo obtener el ID del usuario autenticado");
    }

    private async Task CargarAccesorios()
    {
        var accesorios = await AccesoriosServicio.GetAccesorios();

        bicicletaBase = accesorios.FirstOrDefault(a => a.Nombre == "Bicicleta");

        if (bicicletaBase != null)
            precioTotal += bicicletaBase.Precio;

        foreach (var tipo in tiposAccesorios)
        {
            accesoriosPorTipo[tipo] = accesorios.Where(a => a.Nombre == tipo).ToList();
        }
    }

    private async Task CargarModeloBicicleta()
    {
        if (bicicletaBase?.RutaImagen != null)
        {
            rutaModelo3D = bicicletaBase.RutaImagen;
            await JSRuntime.InvokeVoidAsync("inicializarModeloBicicleta", rutaModelo3D);
        }
    }

    private async Task CambiarAccesorio(string tipo, string accesorioId)
    {
        if (string.IsNullOrEmpty(accesorioId))
        {
            if (accesoriosSeleccionados.Remove(tipo, out var acc))
                precioTotal -= acc.Precio;
        }
        else
        {
            var accesorio = accesoriosPorTipo[tipo]
                .FirstOrDefault(a => a.Id.ToString() == accesorioId);

            if (accesorio != null)
            {
                if (accesoriosSeleccionados.ContainsKey(tipo))
                    precioTotal -= accesoriosSeleccionados[tipo].Precio;

                accesoriosSeleccionados[tipo] = accesorio;
                precioTotal += accesorio.Precio;
            }
        }

        await ActualizarModeloBicicleta();
    }

    private async Task ActualizarModeloBicicleta()
    {
        var data = accesoriosSeleccionados.Select(a => new
        {
            tipo = a.Key,
            id = a.Value.Id,
            rutaImagen = a.Value.RutaImagen,
            descripcion = a.Value.Descripcion
        });

        await JSRuntime.InvokeVoidAsync("actualizarModeloBicicleta", data);
    }

    private async Task CambiarColorBicicleta()
    {
        await JSRuntime.InvokeVoidAsync("cambiarColorBicicleta", colorBicicleta);
    }

    private async Task RealizarPedido()
    {
        if (userId == 0)
        {
            await JSRuntime.InvokeVoidAsync("alert", "No se pudo obtener el ID del usuario");
            return;
        }

        var pedido = new PedidosComprasDto
        {
            UsuarioId = userId,
            PrecioTotal = precioTotal,
            FechaCreacion = DateTime.Now,
            Estado = EstadoPedido.Pendiente,
            ColorBicicleta = colorBicicleta
        };

        pedido.Items.Add(new PedidosItemsDto
        {
            AccesorioId = bicicletaBase.Id,
            Cantidad = 1
        });

        foreach (var acc in accesoriosSeleccionados.Values)
        {
            pedido.Items.Add(new PedidosItemsDto
            {
                AccesorioId = acc.Id,
                Cantidad = 1
            });
        }

        await CarritoComprasServicio.AgregarPedido(pedido);
        NavigationManager.NavigateTo("/MonitoreoPedidos");
    }
}
