@page "/bicicleta-personalizada"

@using Newtonsoft.Json
@using PersonalizacionProyectoGradoWASM.Servicios.IServicios
@using PersonalizacionProyectoGradoWASM.Modelos
@using Microsoft.AspNetCore.Authorization
@using Blazored.LocalStorage
@using PersonalizacionProyectoGradoWASM.Helpers

@inject IJSRuntime JSRuntime
@inject IAccesoriosServicio AccesoriosServicio
@inject IPedidosServicio CarritoComprasServicio
@inject NavigationManager NavigationManager
@inject ILocalStorageService LocalStorage

@attribute [Authorize(Roles = "1")]

<PageTitle>Personaliza tu Bicicleta</PageTitle>

<section id="personalizar">
    <div class="grid-layout">

        <!-- COLUMNA IZQUIERDA -->
        <div class="left-panel card">
            <h2 class="title">Accesorios</h2>

            @foreach (var tipoAccesorio in tiposAccesorios)
            {
                <div class="form-group">
                    <label>@tipoAccesorio:</label>
                    <select class="select-input"
                            @onchange="@(e => CambiarAccesorio(tipoAccesorio, e.Value?.ToString()))">
                        <option value="">Seleccione @tipoAccesorio</option>

                        @if (accesoriosPorTipo.ContainsKey(tipoAccesorio))
                        {
                            @foreach (var accesorio in accesoriosPorTipo[tipoAccesorio])
                            {
                                <option value="@accesorio.Id">
                                    @accesorio.Descripcion - Bs @accesorio.Precio.ToString("F2")
                                </option>
                            }
                        }
                    </select>
                </div>
            }
        </div>

        <!-- CANVAS 3D -->
        <div class="center-panel">
            <div class="canvas-wrapper">
                <canvas id="renderCanvas"></canvas>
            </div>
        </div>

        <!-- COLUMNA DERECHA -->
        <div class="right-panel">

            <div class="card small-card">
                <p class="price-label">Color</p>
                <input type="color"
                       class="input-color"
                       @bind="colorBicicleta"
                       @bind:event="oninput"
                       @onchange="CambiarColorBicicleta" />
            </div>

            <div class="card small-card">
                <p class="price-label">Precio Total</p>
                <p class="price-value">Bs @precioTotal.ToString("F2")</p>
            </div>

            <button class="btn-main" @onclick="RealizarPedido">
                Realizar Pedido
            </button>

        </div>
    </div>
</section>

@code {
    private string rutaModelo3D;
    private List<string> tiposAccesorios = new()
    {
        "Montura", "Bocina", "Canasta", "Espejos", "Mangos", "Timbre", "Asiento para Niño "
    };

    private Dictionary<string, List<Accesorio>> accesoriosPorTipo = new();
    private Dictionary<string, Accesorio> accesoriosSeleccionados = new();

    private double precioTotal = 0;
    private Accesorio bicicletaBase;
    private int userId;
    private string colorBicicleta = "#000000";
    private bool inicializado = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        try
        {
            // ✅ OBTENER EL USER ID PRIMERO
            await ObtenerUsuarioIdDesdeLocalStorage();

            // ✅ LUEGO CARGAR LOS DATOS
            await CargarAccesorios();
            await CargarModeloBicicleta();

            StateHasChanged();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error al inicializar: {ex.Message}");
            NavigationManager.NavigateTo("/Acceder");
        }
    }

    private async Task ObtenerUsuarioIdDesdeLocalStorage()
    {
        var idString = await LocalStorage.GetItemAsync<string>(Inicializar.Id_Usuario_Local);

        if (string.IsNullOrEmpty(idString))
        {
            throw new Exception("No se encontró el ID del usuario en localStorage");
        }

        if (!int.TryParse(idString, out userId) || userId <= 0)
        {
            throw new Exception("ID de usuario inválido");
        }

        Console.WriteLine($"✅ Usuario autenticado con ID: {userId}");
    }

    private async Task CargarAccesorios()
    {
        var accesorios = await AccesoriosServicio.GetAccesorios();

        bicicletaBase = accesorios.FirstOrDefault(a => a.Nombre == "Bicicleta");

        if (bicicletaBase != null)
            precioTotal += bicicletaBase.Precio;

        foreach (var tipo in tiposAccesorios)
        {
            accesoriosPorTipo[tipo] = accesorios.Where(a => a.Nombre == tipo).ToList();
        }
    }

    private async Task CargarModeloBicicleta()
    {
        if (bicicletaBase?.RutaImagen != null)
        {
            rutaModelo3D = bicicletaBase.RutaImagen;
            await JSRuntime.InvokeVoidAsync("inicializarModeloBicicleta", rutaModelo3D);
        }
    }

    private async Task CambiarAccesorio(string tipo, string accesorioId)
    {
        if (string.IsNullOrEmpty(accesorioId))
        {
            if (accesoriosSeleccionados.Remove(tipo, out var acc))
                precioTotal -= acc.Precio;
        }
        else
        {
            var accesorio = accesoriosPorTipo[tipo]
                .FirstOrDefault(a => a.Id.ToString() == accesorioId);

            if (accesorio != null)
            {
                if (accesoriosSeleccionados.ContainsKey(tipo))
                    precioTotal -= accesoriosSeleccionados[tipo].Precio;

                accesoriosSeleccionados[tipo] = accesorio;
                precioTotal += accesorio.Precio;
            }
        }

        await ActualizarModeloBicicleta();
    }

    private async Task ActualizarModeloBicicleta()
    {
        var data = accesoriosSeleccionados.Select(a => new
        {
            tipo = a.Key,
            id = a.Value.Id,
            rutaImagen = a.Value.RutaImagen,
            descripcion = a.Value.Descripcion
        });

        await JSRuntime.InvokeVoidAsync("actualizarModeloBicicleta", data);
    }

    private async Task CambiarColorBicicleta()
    {
        await JSRuntime.InvokeVoidAsync("cambiarColorBicicleta", colorBicicleta);
    }

    private async Task RealizarPedido()
    {
        // ✅ VALIDACIÓN MEJORADA
        if (userId <= 0)
        {
            await JSRuntime.InvokeVoidAsync("alert", "Error: Usuario no identificado. Por favor, inicie sesión nuevamente.");
            NavigationManager.NavigateTo("/Acceder");
            return;
        }

        try
        {
            var pedido = new PedidosComprasDto
            {
                UsuarioId = userId,
                PrecioTotal = precioTotal,
                FechaCreacion = DateTime.Now,
                Estado = EstadoPedido.Pendiente,
                ColorBicicleta = colorBicicleta
            };

            Console.WriteLine($"🚀 Creando pedido para usuario ID: {userId}");

            // ✅ AGREGAR BICICLETA BASE
            if (bicicletaBase != null)
            {
                pedido.Items.Add(new PedidosItemsDto
                {
                    Cantidad = 1,
                    Accesorio = new Accesorio
                    {
                        Id = bicicletaBase.Id
                    }
                });
                Console.WriteLine($"  - Bicicleta base: {bicicletaBase.Id}");
            }

            // ✅ AGREGAR ACCESORIOS SELECCIONADOS
            foreach (var acc in accesoriosSeleccionados.Values)
            {
                pedido.Items.Add(new PedidosItemsDto
                {
                    Cantidad = 1,
                    Accesorio = new Accesorio
                    {
                        Id = acc.Id
                    }
                });
                Console.WriteLine($"  - Accesorio: {acc.Descripcion} (ID: {acc.Id})");
            }

            Console.WriteLine($"📦 Total items: {pedido.Items.Count}, Precio: Bs {precioTotal:F2}");

            await CarritoComprasServicio.AgregarPedido(pedido);

            await JSRuntime.InvokeVoidAsync("alert", "¡Pedido realizado exitosamente!");
            NavigationManager.NavigateTo("/MonitoreoPedidos");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error al realizar pedido: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("alert", $"Error al procesar el pedido: {ex.Message}");
        }
    }
}