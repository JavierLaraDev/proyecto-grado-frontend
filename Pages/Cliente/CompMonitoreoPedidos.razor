@page "/MonitoreoPedidos"
@attribute [Authorize(Roles = "1")]

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using PersonalizacionProyectoGradoWASM.Modelos
@using PersonalizacionProyectoGradoWASM.Servicios.IServicios
@using System.Security.Claims

@inject IPedidosServicio PedidosServicio
@inject AuthenticationStateProvider AuthenticationStateProvider

<section id="mp-pedidos">
    <div class="mp-container">

        <!-- HEADER -->
        <div class="mp-header">
            <h1>Mis Pedidos</h1>
            <p>Gestiona y revisa el estado de tus pedidos</p>
        </div>

        <!-- STATS / FILTROS -->
        <div class="mp-stats">
            <div class="mp-stat @(filtroEstado == null ? "active" : "")"
                 @onclick="() => CambiarFiltro(null)">
                <span>Total</span>
                <strong>@pedidos.Count</strong>
            </div>

            @foreach (EstadoPedido estado in Enum.GetValues(typeof(EstadoPedido)))
            {
                <div class="mp-stat @estado.ToString().ToLower() @(filtroEstado == estado ? "active" : "")"
                     @onclick="() => CambiarFiltro(estado)">
                    <span>@estado</span>
                    <strong>@pedidos.Count(p => p.Estado == estado)</strong>
                </div>
            }
        </div>

        <!-- LISTA DE PEDIDOS -->
        @if (!pedidosFiltrados.Any())
        {
            <div class="mp-empty">
                No tienes pedidos en esta categoría.
            </div>
        }
        else
        {
            @foreach (var pedido in pedidosFiltrados.OrderByDescending(p => p.Id))
            {
                <div class="mp-order-card">

                    <div class="mp-order-header">
                        <div>
                            <h3>Pedido #@pedido.Id</h3>
                            <span class="mp-status @pedido.Estado.ToString().ToLower()">
                                @pedido.Estado
                            </span>
                        </div>

                        <div class="mp-total">
                            Bs @pedido.PrecioTotal.ToString("F2")
                        </div>
                    </div>

                    <div class="mp-order-body">
                        <p>@pedido.Items.Count artículo(s)</p>

                        <button class="mp-btn"
                                @onclick="() => pedidoSeleccionado = pedido">
                            Ver detalles
                        </button>
                    </div>

                </div>
            }
        }

    </div>
</section>

<!-- MODAL DETALLE -->
@if (pedidoSeleccionado != null)
{
    <div class="mp-modal-backdrop">
        <div class="mp-modal">

            <div class="mp-modal-header">
                <h2>Pedido #@pedidoSeleccionado.Id</h2>
                <button @onclick="CerrarModal">✖</button>
            </div>

            <div class="mp-modal-body">
                @foreach (var item in pedidoSeleccionado.Items)
                {
                    <div class="mp-item">
                        <span>@item.Accesorio.Descripcion</span>
                        <span>x @item.Cantidad</span>
                        <span>
                            Bs @((item.Accesorio.Precio * item.Cantidad).ToString("F2"))
                        </span>
                    </div>
                }

                <div class="mp-modal-total">
                    Total: Bs @pedidoSeleccionado.PrecioTotal.ToString("F2")
                </div>
            </div>

        </div>
    </div>
}

@code {

    private List<PedidosComprasDto> pedidos = new();
    private List<PedidosComprasDto> pedidosFiltrados = new();

    private EstadoPedido? filtroEstado = null;
    private PedidosComprasDto pedidoSeleccionado;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        var userId = int.Parse(user.FindFirst(ClaimTypes.NameIdentifier).Value);

        pedidos = await PedidosServicio.GetPedidosUsuario(userId);
        AplicarFiltro();
    }

    private void CambiarFiltro(EstadoPedido? estado)
    {
        filtroEstado = estado;
        AplicarFiltro();
    }

    private void AplicarFiltro()
    {
        pedidosFiltrados = filtroEstado == null
            ? pedidos
            : pedidos.Where(p => p.Estado == filtroEstado).ToList();
    }

    private void CerrarModal()
    {
        pedidoSeleccionado = null;
    }
}
