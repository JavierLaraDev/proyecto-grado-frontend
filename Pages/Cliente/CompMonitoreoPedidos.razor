@page "/MonitoreoPedidos"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using PersonalizacionProyectoGradoWASM.Modelos
@using PersonalizacionProyectoGradoWASM.Servicios.IServicios
@using System.Security.Claims

@inject IPedidosServicio PedidosServicio
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JSRuntime

@attribute [Authorize(Roles = "1")]

<section id="orders">
    <div class="orders-wrapper">

        <h1 class="orders-title">Mis pedidos</h1>

        @if (pedidos.Any())
        {
            @foreach (var pedido in pedidos.OrderByDescending(p => p.Id))
            {
                <article class="order-card" @key="pedido.Id">

                    <!-- Header -->
                    <header class="order-header">
                        <div>
                            <span class="order-id">Pedido #@pedido.Id</span>
                            <span class="order-sub">Seguimiento del pedido</span>
                        </div>

                        <span class="order-status @pedido.Estado.ToString().ToLower()">
                            @pedido.Estado
                        </span>
                    </header>

                    <!-- Body -->
                    <div class="order-body">

                        <div class="order-items">
                            @if (pedido.Items != null && pedido.Items.Any())
                            {
                                @foreach (var item in pedido.Items)
                                {
                                    <div class="order-item">
                                        <span class="item-name">@item.Accesorio.Descripcion</span>
                                        <span class="item-qty">x@item.Cantidad</span>
                                        <span class="item-price">
                                            Bs @((item.Accesorio.Precio * item.Cantidad).ToString("F2"))
                                        </span>
                                    </div>
                                }
                            }
                            else
                            {
                                <p class="orders-empty">Pedido sin detalles.</p>
                            }
                        </div>

                        <div class="order-total">
                            <span>Total</span>
                            <strong>Bs @pedido.PrecioTotal.ToString("F2")</strong>
                        </div>

                        @if (pedido.Estado != EstadoPedido.Cancelado &&
                                        pedido.Estado != EstadoPedido.Entregado)
                        {
                            <button class="order-cancel"
                                    @onclick="() => CancelarPedido(pedido.Id)">
                                Cancelar pedido
                            </button>
                        }

                    </div>
                </article>
            }
        }
        else
        {
            <p class="orders-empty">No tiene pedidos registrados.</p>
        }

    </div>
</section>

@code {

    // 🔥 IMPORTANTE: inicializada para evitar NullReference
    private List<PedidosComprasDto> pedidos = new();

    private int userId;

    protected override async Task OnInitializedAsync()
    {
        await ObtenerUsuarioId();
        await CargarPedidos();
    }

    private async Task ObtenerUsuarioId()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (!user.Identity?.IsAuthenticated ?? true)
            return;

        var userIdClaim = user.FindFirst(ClaimTypes.NameIdentifier);

        if (userIdClaim != null && int.TryParse(userIdClaim.Value, out int parsedUserId))
        {
            userId = parsedUserId;
            Console.WriteLine($"Usuario autenticado. ID: {userId}");
        }
        else
        {
            Console.WriteLine("No se pudo obtener el ID del usuario.");
        }
    }

    private async Task CargarPedidos()
    {
        try
        {
            Console.WriteLine($"Cargando pedidos del usuario {userId}");
            var resultado = await PedidosServicio.GetPedidosUsuario(userId);

            pedidos = resultado ?? new();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar pedidos: {ex.Message}");
            await JSRuntime.InvokeVoidAsync(
                "alert",
                "Ocurrió un error al cargar sus pedidos."
            );
        }
    }

    private async Task CancelarPedido(int pedidoId)
    {
        try
        {
            var ok = await PedidosServicio.ActualizarEstadoPedido(
                pedidoId,
                EstadoPedido.Cancelado
            );

            if (ok)
            {
                await JSRuntime.InvokeVoidAsync(
                    "alert",
                    "Pedido cancelado con éxito."
                );

                await CargarPedidos();
            }
            else
            {
                await JSRuntime.InvokeVoidAsync(
                    "alert",
                    "No se pudo cancelar el pedido."
                );
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cancelar pedido: {ex.Message}");
            await JSRuntime.InvokeVoidAsync(
                "alert",
                "Error inesperado al cancelar el pedido."
            );
        }
    }
}
