@page "/MonitoreoPedidos"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using PersonalizacionProyectoGradoWASM.Modelos
@using PersonalizacionProyectoGradoWASM.Servicios.IServicios
@using System.Security.Claims
@inject IPedidosServicio PedidosServicio
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JSRuntime
@attribute [Authorize(Roles = "1")]

<section id="mp-pedidos">
    <div class="mp-container">

        <h2 class="mp-title">Mis pedidos</h2>

        @if (pedidos != null && pedidos.Any())
        {
            @foreach (var pedido in pedidos.OrderByDescending(p => p.Id))
            {
                <article class="mp-card">

                    <!-- Header -->
                    <header class="mp-card-header">
                        <div>
                            <span class="mp-order">Pedido #@pedido.Id</span>
                            <span class="mp-date">Estado actual</span>
                        </div>

                        <span class="mp-status @pedido.Estado.ToString().ToLower()">
                            @pedido.Estado
                        </span>
                    </header>

                    <!-- Body -->
                    <div class="mp-card-body">

                        <h4 class="mp-subtitle">Accesorios</h4>

                        <ul class="mp-items">
                            @foreach (var item in pedido.Items)
                            {
                                <li class="mp-item">
                                    <span>@item.Accesorio.Descripcion</span>
                                    <span>x@item.Cantidad</span>
                                    <strong>
                                        Bs @((item.Accesorio.Precio * item.Cantidad).ToString("F2"))
                                    </strong>
                                </li>
                            }
                        </ul>

                        <div class="mp-total-box">
                            <span>Total</span>
                            <strong>Bs @pedido.PrecioTotal.ToString("F2")</strong>
                        </div>

                        @if (pedido.Estado != EstadoPedido.Cancelado &&
                                        pedido.Estado != EstadoPedido.Entregado)
                        {
                            <button class="mp-btn-cancel"
                                    @onclick="() => CancelarPedido(pedido.Id)">
                                Cancelar pedido
                            </button>
                        }

                    </div>
                </article>
            }
        }
        else
        {
            <p class="mp-empty">No tiene pedidos registrados.</p>
        }

    </div>
</section>


@code {
    private List<PedidosComprasDto> pedidos;
    private int userId;

    protected override async Task OnInitializedAsync()
    {
        await ObtenerUsuarioId();
        await CargarPedidos();
    }

    private async Task ObtenerUsuarioId()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity.IsAuthenticated)
        {
            var userIdClaim = user.FindFirst(ClaimTypes.NameIdentifier);
            if (userIdClaim != null && int.TryParse(userIdClaim.Value, out int parsedUserId))
            {
                userId = parsedUserId;
                Console.WriteLine($"Usuario autenticado. ID: {userId}");
            }
            else
            {
                Console.WriteLine("No se pudo obtener el ID del usuario del claim.");
            }
        }
        else
        {
            Console.WriteLine("Usuario no autenticado.");
        }
    }

    private async Task CargarPedidos()
    {
        try
        {
            Console.WriteLine($"Intentando cargar pedidos para el usuario con ID: {userId}");
            pedidos = await PedidosServicio.GetPedidosUsuario(userId);

            if (pedidos == null || !pedidos.Any())
            {
                Console.WriteLine($"No se encontraron pedidos para el usuario con ID: {userId}");
            }
            else
            {
                Console.WriteLine($"Se cargaron {pedidos.Count} pedidos para el usuario con ID: {userId}");
                foreach (var pedido in pedidos)
                {
                    Console.WriteLine($"Pedido ID: {pedido.Id}, Items: {pedido.Items?.Count ?? 0}, Estado: {pedido.Estado}, Precio Total: {pedido.PrecioTotal}");
                    if (pedido.Items != null)
                    {
                        foreach (var item in pedido.Items)
                        {
                            Console.WriteLine($"  - Item: AccesorioId: {item.Accesorio.Id}, Cantidad: {item.Cantidad}");
                        }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar los pedidos: {ex.Message}");
            Console.WriteLine($"StackTrace: {ex.StackTrace}");
            await JSRuntime.InvokeVoidAsync("alert", $"Error al cargar los pedidos: {ex.Message}");
        }
    }

    private async Task CancelarPedido(int pedidoId)
    {
        try
        {
            Console.WriteLine($"Intentando cancelar el pedido con ID: {pedidoId}");
            var resultado = await PedidosServicio.ActualizarEstadoPedido(pedidoId, EstadoPedido.Cancelado);
            Console.WriteLine($"Resultado de la actualización: {resultado}");

            if (resultado)
            {
                await JSRuntime.InvokeVoidAsync("alert", "Pedido cancelado con éxito.");
                await CargarPedidos(); // Recargamos los pedidos para reflejar los cambios
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", "No se pudo cancelar el pedido. Por favor, inténtalo de nuevo.");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cancelar el pedido: {ex.Message}");
            Console.WriteLine($"StackTrace: {ex.StackTrace}");
            await JSRuntime.InvokeVoidAsync("alert", $"Error al cancelar el pedido: {ex.Message}");
        }
    }
}